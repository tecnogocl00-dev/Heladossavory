<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos de Helados & Ganancia</title>
    <!-- Carga de Tailwind CSS para un diseño moderno y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de la fuente Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Estilos personalizados para el formulario/tarjeta */
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Estilo para los botones de contador */
        .qty-button {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            line-height: 1;
            padding: 0;
            border-radius: 9999px; /* Botones circulares */
            transition: background-color 0.1s;
        }
        .highlighted-item {
            background-color: #f0f9ff; /* Azul muy claro para resaltar productos pedidos */
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin: 0 -0.5rem; /* Ajuste para que se vea el fondo */
        }
        /* Estilo para el modal */
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
        }
        .modal:not(.hidden) .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Configuración e Inicialización de Firebase (Requerido para apps con persistencia) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Activando logs de debug para visibilidad de Firebase
        setLogLevel('Debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let db, auth;
        let userId = 'loading'; // ID del usuario autenticado o anónimo

        window.onload = async () => {
            try {
                // 1. Inicializar Firebase
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                window.db = db; 
                window.auth = auth;

                // 2. Autenticación
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // 3. Listener de estado de autenticación (Para obtener el userId)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth Ready. User ID:", userId);
                    } else {
                        // Generar ID anónimo si no se pudo autenticar (o usar un valor por defecto)
                        userId = crypto.randomUUID();
                        console.log("Signed in anonymously. User ID:", userId);
                    }
                });

                console.log("Firebase initialized and attempting sign-in...");
            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
            }
        };
    </script>
    
    <!-- Contenedor Principal -->
    <main class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-800">App de Pedidos de Helados</h1>
            <p class="text-gray-600 mt-2">Calcula el total a pagar y la ganancia por pedido.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Columna de Productos (Formulario de Pedido) -->
            <section class="lg:col-span-2 bg-white p-6 rounded-xl card-shadow">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-2">Ingresar Pedido</h2>
                
                <!-- BANNER DE BÚSQUEDA -->
                <div class="mb-4">
                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="Buscar producto por nombre..." 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                        onkeyup="filterProducts()"
                        aria-label="Buscar producto"
                    >
                </div>
                
                <div id="products-container" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    <!-- Los productos se cargarán aquí mediante JavaScript -->
                </div>
                
                <div class="flex space-x-4 mt-8">
                    <!-- Botón de Limpiar Pedido -->
                    <button onclick="clearOrder()" class="w-1/3 py-3 bg-red-500 hover:bg-red-600 text-white font-bold rounded-lg transition duration-200 shadow-md transform hover:scale-[1.01]">
                        Nuevo Pedido (Limpiar)
                    </button>
                    <!-- Botón de Recalcular Factura -->
                    <button onclick="calculateOrder()" class="w-1/3 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition duration-200 shadow-md transform hover:scale-[1.01]">
                        Recalcular
                    </button>
                    <!-- Botón de Exportar por WhatsApp (NUEVO) -->
                    <button onclick="openExportModal()" class="w-1/3 py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-lg transition duration-200 shadow-md transform hover:scale-[1.01]">
                        Exportar por WhatsApp
                    </button>
                </div>
            </section>

            <!-- Columna de Resultados (Factura y Ganancia) -->
            <section class="lg:col-span-1">
                <div class="bg-blue-50 p-6 rounded-xl card-shadow sticky top-4">
                    <h2 class="text-2xl font-semibold mb-6 text-blue-800 border-b border-blue-200 pb-2">Resumen del Pedido</h2>
                    
                    <!-- TOTALES DE FACTURA (NETO + IVA + VENTA) -->
                    <div class="mb-4 space-y-2">
                        <div class="flex justify-between text-lg font-medium text-gray-700">
                            <span>Total Neto:</span>
                            <span id="total-neto" class="font-bold text-gray-800">$ 0</span>
                        </div>
                        <div class="flex justify-between text-lg font-medium text-gray-700">
                            <span>Total IVA (19%):</span>
                            <span id="total-iva" class="font-bold text-red-600">$ 0</span>
                        </div>
                        <div class="pt-2 border-t border-blue-200">
                            <p class="text-lg font-medium text-gray-700">Total Venta (IVA Incluido):</p>
                            <p id="total-venta" class="text-4xl font-extrabold text-blue-600 mt-1" data-raw-value="0">$ 0</p>
                        </div>
                    </div>

                    <!-- Total Ganancia -->
                    <div class="pt-4 border-t border-blue-100">
                        <p class="text-lg font-medium text-gray-700">Ganancia Estimada:</p>
                        <p id="total-ganancia" class="text-4xl font-extrabold text-green-600 mt-1">$ 0</p>
                    </div>
                </div>

                <!-- Detalles de Factura (Opcional, para desglose) -->
                <div class="mt-6 bg-white p-4 rounded-xl card-shadow">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Detalle (Costos y Margen)</h3>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Costo Total (Compra):</span>
                            <span id="total-costo" class="font-medium text-red-500">$ 0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Margen de Ganancia (%):</span>
                            <span id="margen-porcentaje" class="font-medium text-green-600">0.00%</span>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Modal de Exportación por WhatsApp -->
    <div id="export-modal" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white w-full max-w-md rounded-xl p-6 card-shadow">
            <h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">Enviar Pedido por WhatsApp</h3>
            
            <p id="modal-summary" class="text-sm mb-4 bg-yellow-50 p-3 rounded-lg"></p>

            <div class="space-y-3">
                <button onclick="sendOrder('Marcos')" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg transition duration-200 flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.48 1.34 5.03L2.01 22l5.14-1.55c1.47.8 3.12 1.25 4.89 1.25 5.46 0 9.91-4.45 9.91-9.91s-4.45-9.91-9.91-9.91zm4.84 14.73c-.23.63-.82.88-1.56.5-.74-.38-2.4-.92-4.04-1.44-.38-.12-.66-.09-.92.38-.26.46-.73 1.36-1.12 1.73-.39.37-.8.36-1.56.09-.76-.27-2.92-1.07-4.2-3.48-.99-1.8-1.1-2.97-.84-3.44.26-.47.82-.76 1.05-.98.23-.22.5-.54.66-.82.16-.27.24-.5.39-.73.15-.24.08-.45-.04-.63-.12-.18-.94-2.28-1.32-2.73-.38-.45-.73-.37-1.1-.37-.37 0-.74-.01-1.12-.01-.38 0-.99.12-1.43.5c-.44.38-1.7 1.66-1.7 4.04 0 2.38 1.74 4.54 1.96 4.89.22.35 3.39 5.25 8.1 7.22.82.34 1.46.54 1.97.64.91.18 1.76.15 2.42.09.73-.07 2.06-.84 2.37-1.6.31-.76.31-1.39.22-1.6.09-.2-.23-.33-.46-.46z"/></svg>
                    <span>Marcos (+56958635985)</span>
                </button>
                <button onclick="sendOrder('Rafa')" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg transition duration-200 flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.48 1.34 5.03L2.01 22l5.14-1.55c1.47.8 3.12 1.25 4.89 1.25 5.46 0 9.91-4.45 9.91-9.91s-4.45-9.91-9.91-9.91zm4.84 14.73c-.23.63-.82.88-1.56.5-.74-.38-2.4-.92-4.04-1.44-.38-.12-.66-.09-.92.38-.26.46-.73 1.36-1.12 1.73-.39.37-.8.36-1.56.09-.76-.27-2.92-1.07-4.2-3.48-.99-1.8-1.1-2.97-.84-3.44.26-.47.82-.76 1.05-.98.23-.22.5-.54.66-.82.16-.27.24-.5.39-.73.15-.24.08-.45-.04-.63-.12-.18-.94-2.28-1.32-2.73-.38-.45-.73-.37-1.1-.37-.37 0-.74-.01-1.12-.01-.38 0-.99.12-1.43.5c-.44.38-1.7 1.66-1.7 4.04 0 2.38 1.74 4.54 1.96 4.89.22.35 3.39 5.25 8.1 7.22.82.34 1.46.54 1.97.64.91.18 1.76.15 2.42.09.73-.07 2.06-.84 2.37-1.6.31-.76.31-1.39.22-1.6.09-.2-.23-.33-.46-.46z"/></svg>
                    <span>Rafa (+56958635986)</span>
                </button>
            </div>
            
            <button onclick="closeExportModal()" class="w-full mt-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold rounded-lg transition duration-200">
                Cerrar
            </button>
        </div>
    </div>
    <!-- Fin Modal -->

    <script>
        // TASA DE IVA ASUMIDA (19% para Chile)
        const IVA_RATE = 0.19; 

        // Contactos predefinidos para WhatsApp
        const WHATSAPP_CONTACTS = {
            Marcos: '+56958635985',
            Rafa: '+56958635986'
        };

        // Definición de Productos con precios extraídos de la imagen
        // Se ha añadido la propiedad 'unitsPerBox' (unidades por caja) a cada producto.
        const PRODUCTS_DATA = [
            // { id: 'p<num>', name: 'Nombre Producto', cost: PrecioCompra, selling: PrecioVenta, unitsPerBox: Unidades }
            { id: 'p1', name: 'CRAZY Helado Chirimoya Alegre 12x190ml', cost: 993, selling: 1182, unitsPerBox: 12 },
            { id: 'p2', name: 'SAHNE NUSS Helado Vaso 12x170ml CL', cost: 993, selling: 1182, unitsPerBox: 12 },
            { id: 'p3', name: 'CRAZY Helado Flocos 12x170ml CL', cost: 993, selling: 1182, unitsPerBox: 12 },
            { id: 'p4', name: 'CRAZY Helado Frambuesa 12x170ml CL', cost: 993, selling: 1182, unitsPerBox: 12 },
            { id: 'p5', name: 'CRAZY Sangurucho Helado Choc 24x125ml CL', cost: 993, selling: 1182, unitsPerBox: 24 },
            { id: 'p6', name: 'CRAZY Sand Helado Vainilla 24x125mlCL', cost: 993, selling: 1182, unitsPerBox: 24 },
            { id: 'p7', name: 'DANKY Helado Choc&Platano 18x125ml CL', cost: 1383, selling: 1646, unitsPerBox: 18 },
            { id: 'p8', name: 'DANKY IC Raspberry&WhiteChoc 18x125ml CL', cost: 1383, selling: 1646, unitsPerBox: 18 },
            { id: 'p9', name: 'DANKY NOGATONGA Ice Cream 18x125ml CL', cost: 1383, selling: 1646, unitsPerBox: 18 },
            { id: 'p10', name: 'DANKY 21 Ice Cream 18x125ml CL', cost: 1383, selling: 1646, unitsPerBox: 18 },
            { id: 'p11', name: 'SAHNE NUSS Cone Ice Cream 18x125ml CL', cost: 1383, selling: 1646, unitsPerBox: 18 },
            { id: 'p12', name: 'LOLLY POP Helado Naranja 20x90ml N2CL', cost: 530, selling: 631, unitsPerBox: 20 },
            { id: 'p13', name: 'SAVORY TRITON Hel Paleta 16x85ml CL', cost: 728, selling: 866, unitsPerBox: 16 },
            { id: 'p14', name: 'EGOCENTRICO Helado 20x85ml CL', cost: 630, selling: 750, unitsPerBox: 20 },
            { id: 'p15', name: 'CROCANLY Helado 20x85ml CL', cost: 630, selling: 750, unitsPerBox: 20 },
            { id: 'p16', name: 'CHOCOLITO Helado 20x85ml CL', cost: 630, selling: 750, unitsPerBox: 20 },
            { id: 'p17', name: 'SAVORY BILZ & PAP Helado 28(2x46.25g) CL', cost: 530, selling: 631, unitsPerBox: 28 },
            { id: 'p18', name: 'SAV Hel Pura Fru Mango 20x75ml CL', cost: 827, selling: 984, unitsPerBox: 20 },
            { id: 'p19', name: 'SAVORY Hel Pura Fruta Framb 22x70ml CL', cost: 827, selling: 984, unitsPerBox: 22 },
            { id: 'p20', name: 'KRiKO Helado Frutilla 20x65ml CL', cost: 530, selling: 631, unitsPerBox: 20 },
            { id: 'p21', name: 'COLA DE TIGRE Helado 26x70ml N3CL', cost: 397, selling: 472, unitsPerBox: 26 },
            { id: 'p22', name: 'TRULULU Super Helado 26x70ml CL', cost: 397, selling: 472, unitsPerBox: 26 },
            { id: 'p23', name: 'KIT KAT GOLD Hel Paleta Prm 16x85ml CL', cost: 1522, selling: 1811, unitsPerBox: 16 },
            { id: 'p24', name: 'MEGA Hel Manjar Galletas 16x90ml N1 CL', cost: 1522, selling: 1811, unitsPerBox: 16 },
            { id: 'p25', name: 'MEGA Helado Almendras Vainilla16x90ml CL', cost: 1522, selling: 1811, unitsPerBox: 16 },
            { id: 'p26', name: 'MEGA Cookies&Cream Helado 16x90ml CL', cost: 1522, selling: 1811, unitsPerBox: 16 },
            { id: 'p27', name: 'KIT KAT Hel Paleta Premium 16x85ml CL', cost: 1522, selling: 1811, unitsPerBox: 16 },
            { id: 'p28', name: 'MEGA SAHNE NUSS Ice Cream 16x90ml CL', cost: 1522, selling: 1811, unitsPerBox: 16 },
            { id: 'p29', name: 'MEGA Ice Cream Strawberry 16x90ml CL', cost: 1522, selling: 1811, unitsPerBox: 16 },
            { id: 'p30', name: 'SAVORY Xplori Hel FRro Dur 20x75g CL', cost: 331, selling: 394, unitsPerBox: 20 },
            { id: 'p31', name: 'SAVORY Helado Paleta Trencito 16x70ml CL', cost: 662, selling: 788, unitsPerBox: 16 },
            { id: 'p32', name: 'SAVORY CENTELLA Galactea Hel 26x37.6g', cost: 232, selling: 276, unitsPerBox: 26 },
            { id: 'p33', name: 'SAVORY CENTELLA Hel Mz Lm 26x52g CL', cost: 232, selling: 276, unitsPerBox: 26 },
        ];

        // Objeto global para almacenar el detalle del pedido actual (para exportación)
        let currentOrderDetails = {
            items: [],
            total: 0, // Total Venta (IVA Incluido)
            neto: 0,
            iva: 0,
            profit: 0
        };


        // Función para formatear números como moneda (Pesos chilenos o similar)
        const currencyFormatter = new Intl.NumberFormat('es-CL', {
            style: 'currency',
            currency: 'CLP', // Usamos CLP (Peso Chileno) como ejemplo
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
        });

        /**
         * Busca un producto por ID en la lista de datos.
         */
        function getProductById(productId) {
            return PRODUCTS_DATA.find(p => p.id === productId);
        }

        /**
         * Maneja el incremento o decremento de la cantidad de un producto.
         * @param {string} productId - ID del producto (ej: 'p1').
         * @param {number} delta - Cantidad de unidades a sumar/restar (puede ser 1 o unitsPerBox).
         */
        function updateQuantity(productId, delta) {
            const input = document.getElementById(`qty-${productId}`);
            if (input) {
                let quantity = parseInt(input.value, 10) || 0;
                quantity += delta;
                
                // Asegurarse de que la cantidad no sea menor que cero
                if (quantity < 0) {
                    quantity = 0;
                }
                
                input.value = quantity;
                calculateOrder(); // Recalcula el total automáticamente
            }
        }

        /**
         * Genera el HTML para la lista de productos basada en los datos filtrados.
         * Se actualiza para incluir botones +/- para Unidad y Caja.
         * @param {Array<Object>} products - Lista de productos a renderizar.
         */
        function renderProducts(products) {
            const container = document.getElementById('products-container');
            container.innerHTML = products.map((product, index) => {
                const existingInput = document.getElementById(`qty-${product.id}`);
                const quantity = existingInput ? parseInt(existingInput.value, 10) || 0 : 0;
                const highlightClass = quantity > 0 ? 'highlighted-item' : '';
                
                const boxPrice = product.selling * product.unitsPerBox;

                return `
                    <div id="item-${product.id}" class="product-item flex flex-col md:flex-row items-start md:items-center justify-between border-b last:border-b-0 py-3 ${highlightClass}">
                        
                        <!-- INFO DEL PRODUCTO -->
                        <div class="flex-1 pr-4 mb-2 md:mb-0">
                            <p class="font-medium text-gray-800">
                                <span class="font-bold text-blue-600 mr-2">${index + 1}.</span> ${product.name}
                            </p>
                            <p class="text-xs text-gray-500 mt-1">
                                Precio Unitario: ${curr
