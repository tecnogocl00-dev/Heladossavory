<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Pedidos Helados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Estilos para inputs num√©ricos sin flechas */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        
        // Iconos
        const Calculator = () => <i data-lucide="calculator" className="w-5 h-5"></i>;
        const BoxIcon = () => <i data-lucide="package" className="w-4 h-4"></i>;
        const UnitIcon = () => <i data-lucide="circle-dot" className="w-4 h-4"></i>;
        const SearchIcon = () => <i data-lucide="search" className="w-5 h-5 text-gray-400"></i>;
        const TrashIcon = () => <i data-lucide="trash-2" className="w-4 h-4"></i>;
        const ShareIcon = () => <i data-lucide="share-2" className="w-5 h-5"></i>;
        const WhatsAppIcon = () => <i data-lucide="message-circle" className="w-5 h-5"></i>;
        const UserIcon = () => <i data-lucide="user" className="w-4 h-4"></i>;
        const EditIcon = () => <i data-lucide="pencil" className="w-3 h-3"></i>;
        const ResetIcon = () => <i data-lucide="rotate-ccw" className="w-3 h-3"></i>;
        const PlusIcon = () => <i data-lucide="plus" className="w-4 h-4"></i>;
        const XIcon = () => <i data-lucide="x" className="w-5 h-5"></i>;

        // Contactos
        const CONTACTS = [
            { name: "Rafael", number: "56958635986" },
            { name: "Marcos", number: "56958635985" },
            { name: "Marcos Papa", number: "5693320745" },
            { name: "Gabi", number: "56981744548" }
        ];

        // Datos Iniciales (Base de datos)
        const INITIAL_DATA = [
            { id: 1, name: "CRAZY Helado Chirimoya Alegre", desc: "12x190ml", unitsPerBox: 12, costNet: 993, costGross: 1182, srp: 1501, category: "Crazy" },
            { id: 2, name: "SAHNE NUSS Helado Vaso", desc: "12x170ml CL", unitsPerBox: 12, costNet: 993, costGross: 1182, srp: 1501, category: "Potes" },
            { id: 3, name: "CRAZY Helado Flocos", desc: "12x170ml CL", unitsPerBox: 12, costNet: 993, costGross: 1182, srp: 1501, category: "Crazy" },
            { id: 4, name: "CRAZY Helado Frambuesa", desc: "12x170ml CL", unitsPerBox: 12, costNet: 993, costGross: 1182, srp: 1501, category: "Crazy" },
            { id: 5, name: "CRAZY Sangurucho Helado Choc", desc: "24x125ml CL", unitsPerBox: 24, costNet: 993, costGross: 1182, srp: 1501, category: "Crazy" },
            { id: 6, name: "CRAZY Sand Helado Vainilla", desc: "24x125ml CL", unitsPerBox: 24, costNet: 993, costGross: 1182, srp: 1501, category: "Crazy" },
            { id: 7, name: "DANKY Helado Choc&Platano", desc: "18x125ml CL", unitsPerBox: 18, costNet: 1383, costGross: 1646, srp: 2090, category: "Danky" },
            { id: 8, name: "DANKY IC Raspberry&WhiteChoc", desc: "18x125ml CL", unitsPerBox: 18, costNet: 1383, costGross: 1646, srp: 2090, category: "Danky" },
            { id: 9, name: "DANKY NOGATONGA Ice Cream", desc: "18x125ml CL", unitsPerBox: 18, costNet: 1383, costGross: 1646, srp: 2090, category: "Danky" },
            { id: 10, name: "DANKY 21 Ice Cream", desc: "18x125ml CL", unitsPerBox: 18, costNet: 1383, costGross: 1646, srp: 2090, category: "Danky" },
            { id: 11, name: "SAHNE NUSS Cone Ice Cream", desc: "18x125ml CL", unitsPerBox: 18, costNet: 1383, costGross: 1646, srp: 2090, category: "Conos" },
            { id: 12, name: "LOLLY POP Helado Naranja", desc: "20x90ml N2CL", unitsPerBox: 20, costNet: 530, costGross: 631, srp: 801, category: "Ni√±os" },
            { id: 13, name: "SAVORY TRITON Hel Paleta", desc: "16x85ml CL", unitsPerBox: 16, costNet: 728, costGross: 866, srp: 1100, category: "Paletas" },
            { id: 14, name: "EGOCENTRICO Helado", desc: "20x85ml CL", unitsPerBox: 20, costNet: 630, costGross: 750, srp: 952, category: "Paletas" },
            { id: 15, name: "CROCANTY Helado", desc: "20x90ml CL", unitsPerBox: 20, costNet: 630, costGross: 750, srp: 952, category: "Paletas" },
            { id: 16, name: "CHOCOLITO Helado", desc: "20x85ml CL", unitsPerBox: 20, costNet: 630, costGross: 750, srp: 952, category: "Paletas" },
            { id: 17, name: "SAVORY BILZ & PAP Helado", desc: "28(2x46.25g) CL", unitsPerBox: 28, costNet: 530, costGross: 631, srp: 801, category: "Ni√±os" },
            { id: 18, name: "SAV Hel Pura Fru Mango", desc: "20x75ml CL", unitsPerBox: 20, costNet: 827, costGross: 984, srp: 1250, category: "Fruta" },
            { id: 19, name: "SAVORY Hel Pura Fruta Framb", desc: "22x70ml CL", unitsPerBox: 22, costNet: 827, costGross: 984, srp: 1250, category: "Fruta" },
            { id: 20, name: "KRIKO Helado Frutilla", desc: "20x65ml CL", unitsPerBox: 20, costNet: 530, costGross: 631, srp: 801, category: "Ni√±os" },
            { id: 21, name: "COLA DE TIGRE Helado", desc: "26x70ml N3CL", unitsPerBox: 26, costNet: 397, costGross: 472, srp: 600, category: "Ni√±os" },
            { id: 22, name: "TRULULU Super Helado", desc: "26x70ml CL", unitsPerBox: 26, costNet: 397, costGross: 472, srp: 600, category: "Ni√±os" },
            { id: 23, name: "KIT KAT GOLD Hel Paleta Prm", desc: "16x85ml CL", unitsPerBox: 16, costNet: 1522, costGross: 1811, srp: 2300, category: "Premium" },
            { id: 24, name: "MEGA Hel Manjar Galletas", desc: "16x90ml N1 CL", unitsPerBox: 16, costNet: 1522, costGross: 1811, srp: 2300, category: "Mega" },
            { id: 25, name: "MEGA Helado Almendras Vainilla", desc: "16x90ml CL", unitsPerBox: 16, costNet: 1522, costGross: 1811, srp: 2300, category: "Mega" },
            { id: 26, name: "MEGA Cookies&Cream Helado", desc: "16x90ml CL", unitsPerBox: 16, costNet: 1522, costGross: 1811, srp: 2300, category: "Mega" },
            { id: 27, name: "KIT KAT Hel Paleta Premium", desc: "16x85ml CL", unitsPerBox: 16, costNet: 1522, costGross: 1811, srp: 2300, category: "Premium" },
            { id: 28, name: "MEGA SAHNE NUSS Ice Cream", desc: "16x90ml CL", unitsPerBox: 16, costNet: 1522, costGross: 1811, srp: 2300, category: "Mega" },
            { id: 29, name: "MEGA Ice Cream Strawberry", desc: "16x90ml CL", unitsPerBox: 16, costNet: 1522, costGross: 1811, srp: 2300, category: "Mega" },
            { id: 30, name: "SAVORY Xplori Hel FrRo Dur", desc: "20x75g CL", unitsPerBox: 20, costNet: 331, costGross: 394, srp: 500, category: "Econ√≥mico" },
            { id: 31, name: "SAVORY Helado Paleta Trencito", desc: "16x70ml CL", unitsPerBox: 16, costNet: 662, costGross: 788, srp: 1000, category: "Paletas" },
            { id: 32, name: "SAVORY CENTELLA Galactea Hel", desc: "26x37.6g", unitsPerBox: 26, costNet: 232, costGross: 276, srp: 351, category: "Econ√≥mico" },
            { id: 33, name: "SAVORY CENTELLA Hel Mz Lm", desc: "26x52g CL", unitsPerBox: 26, costNet: 232, costGross: 276, srp: 351, category: "Econ√≥mico" }
        ];

        // Utilidades
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(value);
        };

        const App = () => {
            // Estados
            const [products, setProducts] = useState(() => {
                const saved = localStorage.getItem('savedPrices');
                if (saved) {
                    try {
                        const parsedSaved = JSON.parse(saved);
                        // Merge: Si hay productos originales, usar sus precios guardados. Si hay productos NUEVOS en el array original, agregarlos.
                        // Adem√°s, si hay productos CUSTOM en localStorage, mantenerlos.
                        
                        // 1. Crear mapa de productos guardados
                        const savedMap = new Map(parsedSaved.map(p => [p.id, p]));
                        
                        // 2. Recorrer INITIAL_DATA y actualizar con lo guardado
                        const mergedInitial = INITIAL_DATA.map(p => {
                            const savedProduct = savedMap.get(p.id);
                            return savedProduct ? { ...p, costGross: savedProduct.costGross, srp: savedProduct.srp } : p;
                        });

                        // 3. Encontrar productos totalmente nuevos creados por el usuario (IDs que no est√°n en INITIAL_DATA)
                        const customProducts = parsedSaved.filter(p => !INITIAL_DATA.some(init => init.id === p.id));

                        return [...mergedInitial, ...customProducts];
                    } catch (e) {
                        return INITIAL_DATA;
                    }
                }
                return INITIAL_DATA;
            });

            const [quantities, setQuantities] = useState(() => {
                const saved = localStorage.getItem('savedOrder');
                return saved ? JSON.parse(saved) : {};
            });

            const [searchTerm, setSearchTerm] = useState("");
            const [selectedCategory, setSelectedCategory] = useState("Todos");
            const [showSummary, setShowSummary] = useState(false);
            const [showAddProduct, setShowAddProduct] = useState(false);
            const [confirmDelete, setConfirmDelete] = useState(false);

            // Estado para formulario de nuevo producto
            const [newProductData, setNewProductData] = useState({
                name: '',
                category: '',
                unitsPerBox: '',
                costGross: '',
                srp: ''
            });

            // Persistencia
            useEffect(() => {
                localStorage.setItem('savedPrices', JSON.stringify(products));
            }, [products]);

            useEffect(() => {
                localStorage.setItem('savedOrder', JSON.stringify(quantities));
            }, [quantities]);

            // Iconos
            useEffect(() => {
                lucide.createIcons();
            }, [searchTerm, showSummary, quantities, confirmDelete, products, selectedCategory, showAddProduct]);

            const categories = useMemo(() => {
                return ["Todos", ...new Set(products.map(p => p.category))];
            }, [products]);

            // Manejadores
            const handleProductUpdate = (id, field, value) => {
                setProducts(prev => prev.map(p => p.id === id ? { ...p, [field]: parseFloat(value) || 0 } : p));
            };

            const handleQuantityChange = (id, type, value) => {
                setQuantities(prev => {
                    const current = prev[id] || { units: 0, boxes: 0 };
                    const newVal = Math.max(0, parseInt(value) || 0);
                    const updated = { ...current, [type]: newVal };
                    if (updated.units === 0 && updated.boxes === 0) {
                        const { [id]: _, ...rest } = prev;
                        return rest;
                    }
                    return { ...prev, [id]: updated };
                });
            };

            const increment = (id, type) => {
                setQuantities(prev => {
                    const current = prev[id] || { units: 0, boxes: 0 };
                    return { ...prev, [id]: { ...current, [type]: current[type] + 1 } };
                });
            };

            const decrement = (id, type) => {
                setQuantities(prev => {
                    const current = prev[id] || { units: 0, boxes: 0 };
                    if (current[type] > 0) {
                        const newVal = current[type] - 1;
                        const updated = { ...current, [type]: newVal };
                        if (updated.units === 0 && updated.boxes === 0) {
                            const { [id]: _, ...rest } = prev;
                            return rest;
                        }
                        return { ...prev, [id]: updated };
                    }
                    return prev;
                });
            };

            // Agregar Nuevo Producto
            const handleAddProductSubmit = (e) => {
                e.preventDefault();
                const costGross = parseFloat(newProductData.costGross);
                const costNet = Math.round(costGross / 1.19); // C√°lculo autom√°tico neto aproximado
                
                const newProduct = {
                    id: Date.now(), // ID √∫nico basado en tiempo
                    name: newProductData.name,
                    desc: `${newProductData.unitsPerBox} un/caja (Agregado)`,
                    unitsPerBox: parseInt(newProductData.unitsPerBox),
                    costNet: costNet,
                    costGross: costGross,
                    srp: parseFloat(newProductData.srp),
                    category: newProductData.category || 'Otros'
                };

                setProducts(prev => [...prev, newProduct]);
                setShowAddProduct(false);
                setNewProductData({ name: '', category: '', unitsPerBox: '', costGross: '', srp: '' });
                alert('¬°Producto agregado correctamente!');
            };

            // Restaurar precios (Solo originales)
            const handleRestorePrices = () => {
                if(confirm('¬øRestaurar precios de lista ORIGINALES? Los productos nuevos que creaste SE MANTENDR√ÅN.')) {
                    setProducts(prev => {
                        // Mantener los productos custom (los que no est√°n en INITIAL_DATA)
                        const customProducts = prev.filter(p => !INITIAL_DATA.some(init => init.id === p.id));
                        // Volver a cargar los originales con precios base
                        return [...INITIAL_DATA, ...customProducts];
                    });
                }
            };

            // C√°lculos
            const filteredProducts = useMemo(() => {
                return products.filter(p => {
                    const matchesSearch = p.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                        p.category.toLowerCase().includes(searchTerm.toLowerCase());
                    const matchesCategory = selectedCategory === "Todos" || p.category === selectedCategory;
                    return matchesSearch && matchesCategory;
                });
            }, [searchTerm, products, selectedCategory]);

            const totals = useMemo(() => {
                let totalCostNet = 0;
                let totalCostGross = 0;
                let totalRevenue = 0;
                let totalItems = 0;

                Object.entries(quantities).forEach(([id, qty]) => {
                    const product = products.find(p => p.id === parseInt(id));
                    if (product) {
                        const totalUnits = qty.units + (qty.boxes * product.unitsPerBox);
                        totalCostGross += totalUnits * product.costGross;
                        totalCostNet += totalUnits * (product.costGross / 1.19);
                        totalRevenue += totalUnits * product.srp;
                        totalItems += totalUnits;
                    }
                });

                const profit = totalRevenue - totalCostGross;
                const margin = totalCostGross > 0 ? (profit / totalCostGross) * 100 : 0;

                return { totalCostNet, totalCostGross, totalRevenue, profit, margin, totalItems };
            }, [quantities, products]);

            const handleDelete = () => {
                setQuantities({});
                localStorage.removeItem('savedOrder');
                setShowSummary(false);
                setConfirmDelete(false);
            };

            const handleWhatsAppShare = (phoneNumber) => {
                let message = "*üìã PEDIDO HELADOS - DETALLE*\n";
                message += "--------------------------------\n";
                
                Object.entries(quantities).forEach(([id, qty]) => {
                    const product = products.find(p => p.id === parseInt(id));
                    if (product && (qty.units > 0 || qty.boxes > 0)) {
                        const totalUnits = qty.units + (qty.boxes * product.unitsPerBox);
                        const subtotal = totalUnits * product.costGross;
                        
                        message += `*${product.name}*\n`;
                        if(qty.boxes > 0) message += `üì¶ ${qty.boxes} Cajas\n`;
                        if(qty.units > 0) message += `üç¶ ${qty.units} Unidades\n`;
                        message += `üí∞ Subtotal: ${formatCurrency(subtotal)}\n\n`;
                    }
                });

                message += "--------------------------------\n";
                message += `*üì¶ CANTIDAD TOTAL:* ${totals.totalItems} Helados\n`;
                message += `*üíµ TOTAL A PAGAR:* ${formatCurrency(totals.totalCostGross)}\n`;
                message += "--------------------------------\n";
                message += `üìà Ganancia Est.: ${formatCurrency(totals.profit)}\n`;
                
                const url = phoneNumber 
                    ? `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`
                    : `https://wa.me/?text=${encodeURIComponent(message)}`;
               
                window.open(url, '_blank');
            };

            const selectedItems = useMemo(() => {
                return Object.entries(quantities)
                    .map(([id, qty]) => {
                        const product = products.find(p => p.id === parseInt(id));
                        if(!product || (qty.units === 0 && qty.boxes === 0)) return null;
                        return { ...product, qty };
                    })
                    .filter(Boolean);
            }, [quantities, products]);

            return (
                <div className="min-h-screen pb-24 relative">
                    {/* Header */}
                    <header className="bg-blue-900 text-white shadow-lg sticky top-0 z-10">
                        <div className="max-w-4xl mx-auto p-4 pb-2 flex justify-between items-center">
                            <div>
                                <h1 className="text-xl font-bold">Pedidos Helados</h1>
                                <p className="text-xs text-blue-200 flex items-center gap-1">
                                    Lista Mayorista ‚Ä¢ <span className="font-semibold bg-blue-800 px-1.5 py-0.5 rounded text-blue-100">{products.length} Productos</span>
                                </p>
                            </div>
                            <div className="text-right">
                                <div className="text-xs text-blue-200 uppercase">Total a Llevar</div>
                                <div className="text-2xl font-bold text-white leading-none">{totals.totalItems} <span className="text-sm font-normal">u.</span></div>
                            </div>
                        </div>
                        <div className="bg-blue-800 px-4 py-1 flex justify-between items-center max-w-4xl mx-auto">
                            <span className="text-xs text-blue-200">Ganancia Estimada:</span>
                            <span className={`font-bold text-sm ${totals.profit >= 0 ? 'text-green-300' : 'text-red-300'}`}>{formatCurrency(totals.profit)}</span>
                        </div>
                    </header>

                    <div className="max-w-4xl mx-auto p-4 pt-4">
                        {/* Bot√≥n Agregar Producto y Buscador */}
                        <div className="flex gap-2 mb-4">
                            <button 
                                onClick={() => setShowAddProduct(true)}
                                className="bg-green-600 text-white px-4 rounded-lg flex items-center justify-center shadow-sm hover:bg-green-700 transition-colors"
                            >
                                <PlusIcon />
                            </button>
                            <div className="relative flex-1">
                                <input
                                    type="text"
                                    placeholder="Buscar..."
                                    className="w-full p-3 pl-10 rounded-lg border border-gray-300 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                                <div className="absolute left-3 top-3.5">
                                    <SearchIcon />
                                </div>
                            </div>
                        </div>

                        {/* Filtros por Categor√≠a */}
                        <div className="mb-6">
                            <div className="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
                                {categories.map(cat => (
                                    <button
                                        key={cat}
                                        onClick={() => setSelectedCategory(cat)}
                                        className={`whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-medium transition-colors ${
                                            selectedCategory === cat 
                                            ? 'bg-blue-600 text-white shadow-md' 
                                            : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50'
                                        }`}
                                    >
                                        {cat}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Lista de Productos */}
                        <div className="grid gap-4 md:grid-cols-2">
                            {filteredProducts.map(product => {
                                const qty = quantities[product.id] || { units: 0, boxes: 0 };
                                const hasOrder = qty.units > 0 || qty.boxes > 0;

                                return (
                                    <div key={product.id} className={`bg-white p-4 rounded-xl shadow-sm border-l-4 ${hasOrder ? 'border-blue-500 ring-1 ring-blue-200' : 'border-transparent'}`}>
                                        <div className="flex justify-between items-start mb-2">
                                            <div>
                                                <h3 className="font-bold text-gray-800 leading-tight">{product.name}</h3>
                                                <p className="text-xs text-gray-500 mt-1">{product.desc} ‚Ä¢ Sugerido: <span className="text-green-600 font-semibold">{formatCurrency(product.srp)}</span></p>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-sm font-bold text-gray-700">{formatCurrency(product.costGross)}</div>
                                                <div className="text-[10px] text-gray-400">Costo c/IVA</div>
                                            </div>
                                        </div>

                                        <div className="mt-4 bg-gray-50 p-3 rounded-lg flex flex-col gap-3">
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-2 text-sm text-gray-600">
                                                    <BoxIcon />
                                                    <span className="font-medium">Cajas ({product.unitsPerBox}u)</span>
                                                </div>
                                                <div className="flex items-center bg-white rounded-md shadow-sm border">
                                                    <button onClick={() => decrement(product.id, 'boxes')} className="px-3 py-1 text-blue-600 font-bold hover:bg-blue-50">-</button>
                                                    <input 
                                                        type="number" 
                                                        value={qty.boxes || ''} 
                                                        onChange={(e) => handleQuantityChange(product.id, 'boxes', e.target.value)}
                                                        className="w-12 text-center text-sm font-semibold outline-none"
                                                        placeholder="0"
                                                    />
                                                    <button onClick={() => increment(product.id, 'boxes')} className="px-3 py-1 text-blue-600 font-bold hover:bg-blue-50">+</button>
                                                </div>
                                            </div>

                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-2 text-sm text-gray-600">
                                                    <UnitIcon />
                                                    <span>Unidades</span>
                                                </div>
                                                <div className="flex items-center bg-white rounded-md shadow-sm border">
                                                    <button onClick={() => decrement(product.id, 'units')} className="px-3 py-1 text-blue-600 font-bold hover:bg-blue-50">-</button>
                                                    <input 
                                                        type="number" 
                                                        value={qty.units || ''} 
                                                        onChange={(e) => handleQuantityChange(product.id, 'units', e.target.value)}
                                                        className="w-12 text-center text-sm font-semibold outline-none"
                                                        placeholder="0"
                                                    />
                                                    <button onClick={() => increment(product.id, 'units')} className="px-3 py-1 text-blue-600 font-bold hover:bg-blue-50">+</button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {hasOrder && (
                                            <div className="mt-2 text-right text-xs text-blue-600 font-medium">
                                                Total Unidades: {qty.units + (qty.boxes * product.unitsPerBox)} | Subtotal: {formatCurrency((qty.units + (qty.boxes * product.unitsPerBox)) * product.costGross)}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Footer Resumen */}
                    {totals.totalItems > 0 && (
                        <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] p-4 z-20">
                            <div className="max-w-4xl mx-auto flex justify-between items-center">
                                <div>
                                    <p className="text-xs text-gray-500">Total a Pagar (Con IVA)</p>
                                    <p className="text-xl font-bold text-gray-900">{formatCurrency(totals.totalCostGross)}</p>
                                </div>
                                <button 
                                    onClick={() => setShowSummary(true)}
                                    className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold shadow-lg transform active:scale-95 transition-all flex items-center gap-2"
                                >
                                    Ver Rentabilidad <Calculator />
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Modal: Agregar Producto */}
                    {showAddProduct && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 animate-slide-up shadow-2xl">
                                <div className="flex justify-between items-center mb-4 border-b pb-4">
                                    <h2 className="text-xl font-bold text-gray-800">Nuevo Producto</h2>
                                    <button onClick={() => setShowAddProduct(false)} className="text-gray-400 hover:text-gray-600">
                                        <XIcon />
                                    </button>
                                </div>
                                <form onSubmit={handleAddProductSubmit} className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-700 mb-1">Nombre Helado</label>
                                        <input 
                                            required 
                                            className="w-full p-2 border rounded bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" 
                                            placeholder="Ej: Super Chocolate"
                                            value={newProductData.name}
                                            onChange={e => setNewProductData({...newProductData, name: e.target.value})}
                                        />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-700 mb-1">Categor√≠a</label>
                                            <input 
                                                required 
                                                className="w-full p-2 border rounded bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" 
                                                placeholder="Ej: Paletas"
                                                list="category-list"
                                                value={newProductData.category}
                                                onChange={e => setNewProductData({...newProductData, category: e.target.value})}
                                            />
                                            <datalist id="category-list">
                                                {categories.filter(c => c !== "Todos").map(c => <option key={c} value={c} />)}
                                            </datalist>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-700 mb-1">Unid. x Caja</label>
                                            <input 
                                                required type="number" min="1"
                                                className="w-full p-2 border rounded bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" 
                                                placeholder="Ej: 20"
                                                value={newProductData.unitsPerBox}
                                                onChange={e => setNewProductData({...newProductData, unitsPerBox: e.target.value})}
                                            />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-700 mb-1">Costo c/IVA ($)</label>
                                            <input 
                                                required type="number" min="0"
                                                className="w-full p-2 border rounded bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" 
                                                placeholder="Lo que pagas"
                                                value={newProductData.costGross}
                                                onChange={e => setNewProductData({...newProductData, costGross: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-green-700 mb-1">Precio Venta ($)</label>
                                            <input 
                                                required type="number" min="0"
                                                className="w-full p-2 border border-green-200 rounded bg-green-50 focus:ring-2 focus:ring-green-500 outline-none font-bold text-green-800" 
                                                placeholder="Al p√∫blico"
                                                value={newProductData.srp}
                                                onChange={e => setNewProductData({...newProductData, srp: e.target.value})}
                                            />
                                        </div>
                                    </div>
                                    <button type="submit" className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg mt-4 hover:bg-blue-700">
                                        Guardar Producto
                                    </button>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Modal de Rentabilidad y Edici√≥n */}
                    {showSummary && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
                            <div className="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-6 animate-slide-up flex flex-col max-h-[95vh] shadow-2xl">
                                <div className="flex justify-between items-center mb-4 border-b pb-4 shrink-0">
                                    <h2 className="text-xl font-bold text-gray-800">Resumen y Ajustes</h2>
                                    <button onClick={() => setShowSummary(false)} className="text-gray-400 hover:text-gray-600 p-2">
                                        <span className="text-2xl">&times;</span>
                                    </button>
                                </div>

                                <div className="space-y-4 overflow-y-auto hide-scrollbar flex-1">
                                    {/* Totales Globales */}
                                    <div className="grid grid-cols-2 gap-3 mb-4">
                                        <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                                            <p className="text-xs text-blue-600 font-bold uppercase">Costo Total</p>
                                            <p className="text-lg font-bold text-blue-800">{formatCurrency(totals.totalCostGross)}</p>
                                        </div>
                                        <div className="bg-green-50 p-3 rounded-lg border border-green-100">
                                            <p className="text-xs text-green-600 font-bold uppercase">Venta Total</p>
                                            <p className="text-lg font-bold text-green-800">{formatCurrency(totals.totalRevenue)}</p>
                                        </div>
                                        <div className="bg-gray-50 p-3 rounded-lg border border-gray-200 col-span-2 flex justify-between items-center">
                                            <div>
                                                <p className="text-xs text-gray-500 font-bold uppercase">Tu Ganancia Real</p>
                                                <p className={`text-xl font-bold ${totals.profit >= 0 ? 'text-gray-800' : 'text-red-500'}`}>{formatCurrency(totals.profit)}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-xs text-gray-400 font-bold uppercase">Margen</p>
                                                <p className={`text-lg font-bold ${totals.margin >= 20 ? 'text-green-500' : totals.margin >= 0 ? 'text-yellow-500' : 'text-red-500'}`}>{totals.margin.toFixed(1)}%</p>
                                            </div>
                                        </div>
                                    </div>

                                    <hr className="border-gray-200" />
                                    
                                    {/* Lista de Edici√≥n de Precios */}
                                    <div>
                                        <div className="flex justify-between items-center mb-3">
                                            <h3 className="text-sm font-bold text-gray-700 flex items-center gap-2">
                                                <EditIcon /> Simular Precios
                                            </h3>
                                            <button onClick={handleRestorePrices} className="text-xs text-blue-500 flex items-center gap-1 hover:underline">
                                                <ResetIcon /> Restaurar originales
                                            </button>
                                        </div>
                                        
                                        <div className="space-y-3">
                                            {selectedItems.map(item => {
                                                const itemTotalUnits = item.qty.units + (item.qty.boxes * item.unitsPerBox);
                                                const itemMargin = item.srp > 0 ? ((item.srp - item.costGross) / item.costGross) * 100 : 0;

                                                return (
                                                    <div key={item.id} className="bg-white border border-gray-200 rounded-lg p-3 shadow-sm">
                                                        <div className="flex justify-between mb-2">
                                                            <span className="font-bold text-xs text-gray-800 w-2/3 truncate">{item.name}</span>
                                                            <span className="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">{itemTotalUnits} un.</span>
                                                        </div>
                                                        
                                                        <div className="flex gap-2 items-end">
                                                            <div className="flex-1">
                                                                <label className="text-[10px] text-gray-400 block mb-1">Costo Unit.</label>
                                                                <input 
                                                                    type="number" 
                                                                    className="w-full text-xs p-2 bg-gray-50 border border-gray-200 rounded text-gray-700 focus:ring-1 focus:ring-blue-500 outline-none"
                                                                    value={item.costGross}
                                                                    onChange={(e) => handleProductUpdate(item.id, 'costGross', e.target.value)}
                                                                />
                                                            </div>
                                                            <div className="flex-1">
                                                                <label className="text-[10px] text-green-600 font-bold block mb-1">Precio Venta</label>
                                                                <input 
                                                                    type="number" 
                                                                    className="w-full text-xs p-2 bg-white border border-green-300 rounded text-gray-900 font-bold focus:ring-2 focus:ring-green-500 outline-none"
                                                                    value={item.srp}
                                                                    onChange={(e) => handleProductUpdate(item.id, 'srp', e.target.value)}
                                                                />
                                                            </div>
                                                            <div className="w-12 text-right pb-2">
                                                                <span className={`text-xs font-bold ${itemMargin < 15 ? 'text-red-500' : 'text-green-600'}`}>
                                                                    {itemMargin.toFixed(0)}%
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    {/* Secci√≥n Enviar Pedido */}
                                    <div className="mt-4 pt-4 border-t">
                                        <p className="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2"><WhatsAppIcon className="w-4 h-4 text-green-500"/> Enviar Pedido a:</p>
                                        <div className="grid grid-cols-2 gap-2">
                                            {CONTACTS.map((contact, idx) => (
                                                <button 
                                                    key={idx}
                                                    onClick={() => handleWhatsAppShare(contact.number)}
                                                    className="flex items-center justify-center gap-2 p-2 bg-green-50 hover:bg-green-100 text-green-700 rounded-lg border border-green-200 text-sm font-medium transition-colors"
                                                >
                                                    <UserIcon /> {contact.name}
                                                </button>
                                            ))}
                                            <button 
                                                onClick={() => handleWhatsAppShare("")}
                                                className="flex items-center justify-center gap-2 p-2 bg-gray-50 hover:bg-gray-100 text-gray-700 rounded-lg border border-gray-200 text-sm font-medium col-span-2"
                                            >
                                                <ShareIcon className="w-4 h-4"/> Otro Contacto
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-4 shrink-0">
                                    {!confirmDelete ? (
                                        <button 
                                            onClick={() => setConfirmDelete(true)}
                                            className="w-full py-3 text-red-500 font-medium text-sm hover:bg-red-50 rounded-lg flex items-center justify-center gap-2 transition-colors border border-red-100"
                                        >
                                            <TrashIcon /> Borrar Pedido
                                        </button>
                                    ) : (
                                        <div className="flex gap-2 animate-pulse">
                                            <button 
                                                onClick={() => setConfirmDelete(false)}
                                                className="flex-1 py-3 bg-gray-200 text-gray-700 font-medium rounded-lg"
                                            >
                                                Cancelar
                                            </button>
                                            <button 
                                                onClick={handleDelete}
                                                className="flex-1 py-3 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600"
                                            >
                                                ¬°S√≠, borrar todo!
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

    <style>
        @keyframes slide-up {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .animate-slide-up {
            animation: slide-up 0.3s ease-out;
        }
    </style>
</body>
</html>
